# SpringBoot actuator 알아보기. 

## Actuator Dependencies 설정하기. 

- build.gradle.kts 파일에 다음과 같이 작성하자. 

```kt
implementation("org.springframework.boot:spring-boot-starter-actuator")
```

## Actuator종류 

1. /actuator/health
   - 목적: 애플리케이션의 상태를 확인하기 위한 엔드포인트입니다.
   - 기능: 서비스의 상태를 확인하고 예외적인 상황을 감지할 수 있습니다.
   - 노출 가능 여부:
     - HTTP: 기본적으로 노출 (프로퍼티 설정으로 변경 가능)
     - JMX: 기본적으로 노출
2. /actuator/info
   - 목적: 애플리케이션에 대한 추가 정보를 제공하기 위한 엔드포인트입니다.
   - 기능: 사용자가 정의한 애플리케이션 정보를 노출하고, 환경 구성에 대한 정보를 제공할 수 있습니다.
   - 노출 가능 여부:
     - HTTP: 기본적으로 노출 (프로퍼티 설정으로 변경 가능)
     - JMX: 기본적으로 노출
3. /actuator/metrics
   - 목적: 애플리케이션의 메트릭(성능 지표)을 확인하기 위한 엔드포인트입니다.
   - 기능: CPU 사용량, 메모리 사용량, HTTP 요청 횟수 등과 같은 다양한 메트릭을 확인할 수 있습니다.
   - 노출 가능 여부:
     - HTTP: 기본적으로 노출 (프로퍼티 설정으로 변경 가능)
     - JMX: 기본적으로 노출
4. /actuator/env
   - 목적: 애플리케이션의 환경 설정 정보를 확인하기 위한 엔드포인트입니다.
   - 기능: 애플리케이션의 프로퍼티, 환경 변수, 시스템 속성 등을 확인할 수 있습니다.
   - 노출 가능 여부:
     - HTTP: 기본적으로 노출되지 않음 (프로퍼티 설정으로 변경 가능)
     - JMX: 기본적으로 노출
5. /actuator/loggers
   - 목적: 애플리케이션의 로깅 구성을 확인하고 조정하기 위한 엔드포인트입니다.
   - 기능: 로그 레벨을 동적으로 변경하거나, 특정 패키지 또는 클래스의 로깅 레벨을 설정할 수 있습니다.
   - 노출 가능 여부:
     - HTTP: 기본적으로 노출되지 않음 (프로퍼티 설정으로 변경 가능)
     - JMX: 기본적으로 노출
6. /actuator/beans
   - 목적: 애플리케이션의 빈(Bean) 정보를 확인하기 위한 엔드포인트입니다.
   - 기능: 애플리케이션 컨텍스트에 등록된 빈의 목록과 구성 정보를 확인할 수 있습니다.
   - 노출 가능 여부:
     - HTTP: 기본적으로 노출되지 않음 (프로퍼티 설정으로 변경 가능)
     - JMX: 기본적으로 노출
7. /actuator/mappings
   - 목적: HTTP 요청과 매핑된 핸들러 메소드 정보를 확인하기 위한 엔드포인트입니다.
   - 기능: URL 매핑 정보와 핸들러 메소드의 실행 횟수, 실행 시간 등을 확인할 수 있습니다.
   - 노출 가능 여부:
     - HTTP: 기본적으로 노출되지 않음 (프로퍼티 설정으로 변경 가능)
     - JMX: 기본적으로 노출
8. /actuator/auditevents
   - 목적: 감사 이벤트에 대한 정보를 확인하기 위한 엔드포인트입니다.
   - 기능: 로그인, 로그아웃, 권한 변경 등과 같은 감사 이벤트의 기록을 확인할 수 있습니다.
   - 노출 가능 여부:
     - HTTP: 기본적으로 노출되지 않음 (프로퍼티 설정으로 변경 가능)
     - JMX: 기본적으로 노출
9. /actuator/heapdump
   - 목적: JVM 힙 덤프를 생성하는 엔드포인트입니다.
   - 기능: 애플리케이션의 메모리 사용 상태를 분석하고 문제 해결을 위한 정보를 얻을 수 있습니다.
   - 노출 가능 여부:
     - HTTP: 기본적으로 노출되지 않음 (프로퍼티 설정으로 변경 가능)
     - JMX: 기본적으로 노출
10. /actuator/threaddump
    - 목적: 스레드 덤프를 생성하는 엔드포인트입니다.
    - 기능: 애플리케이션의 스레드 상태를 확인하고 락 상태 등을 분석할 수 있습니다.
    - 노출 가능 여부:
      - HTTP: 기본적으로 노출되지 않음 (프로퍼티 설정으로 변경 가능)
      - JMX: 기본적으로 노출

## 대표설정

- 대표적인 설정은 health, info 2가지이다. 

### health 사용하기. 

- application.properties 혹은 yaml 파일에 다음과 같이 작성한다. 

```kt
management.endpoints.web.exposure.include=health
```

- 스프링부트를 실행하고 http://localhost:8080/actuator/health 로 결과를 확인할 수 있다. 
- 결과는 다음과 같다. 

```kt
{"status":"UP"}
```

#### custom Health Actuator Indicator

- CustomHealthIndicator.kt파일을 만들고 다음과 같이 작성하자. 

```kt
package com.schooldevops.springbootkotlin.indicator

import org.springframework.boot.actuate.health.Health
import org.springframework.boot.actuate.health.HealthIndicator
import org.springframework.stereotype.Component

@Component
class CustomHealthIndicator: HealthIndicator {
    override fun health(): Health {
        val status = "healthy" // 특정 조건에 따라 healthy여부를 결정한다.
        return if (status == "healthy") {
            Health.up().withDetail("message", "Custom health check passed").build()
        } else {
            Health.down().withDetail("message", "Custom health check failed").build()
        }
    }
}
```

- 위와 같이 HealthIndicator를 구현한다. 
- health()라는 메소드 정보를 확인할 수 있고, Health 객체 타입을 반환한다. 
- status 상태에 따라 정상적으로 Up되었는지, 아니면 Down되었는지 파악할 수 있음을 알 수 있다. 

- 테스트하기 

```kt
### health check
GET http://localhost:9999/custom-health
```

- 결과는 다음과 같다. 

```kt
{
  "status": "UP",
  "details": {
    "message": "Custom health check passed"
  }
}
```

- 기본적인 actuator/health에 대해서 다음과 같이 요청해보자. 

```kt
### Default Health Check
GET http://localhost:9999/actuator/health
```

- 결과는 다음과 같다. 

```kt
{
  "status": "UP"
}
```